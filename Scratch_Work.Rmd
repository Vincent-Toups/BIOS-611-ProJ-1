---
title: "Scratch_Work"
author: "Matt Johnson"
date: "8/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gridExtra)
```

```{r}
combine <- read.csv("source_data/combine.csv")
draft <- read.csv("source_data/draft.csv")
```

```{r}
# head(combine)
# str(combine)
# summary(combine)
```

```{r}
# head(draft)
# str(draft)
# summary(draft)
```


Initial cleaning
```{r}
#I'm thinking i'm going to use only data from 2000 on. I think these observations will be more complete. Also since the game has changed so much, this sort of analysis is only really relevant in the modern era of football. I also do not need a lot of these variables, lets select important ones 
Comb.2000 <- combine %>% 
  filter(combineYear >= 2000) %>% 
  select(1:6, 8:18, 28:33)
Draft.2000 <- draft %>% 
  filter(draft >= 2000) %>% 
  select(1:19)
  
#ok lets take out any rows with an NA just to see
Comb.compl <- na.omit(Comb.2000) 
Draft.compl <- na.omit(Draft.2000)[, c(1, 3, 4)]
```

Join and make final single csv

```{r}
#join
DF.clean <- na.omit(left_join(Comb.compl, Draft.compl, by = "playerId")[, -c(1, 3, 4:9, 11:13, 16)])
DF.clean$position <- factor(DF.clean$position)
```

I think I need to split into positions to really see what's up
```{r}
#Lets fist split into offense and defense and then split more from there
DF.Off.skill <- DF.clean %>% 
  filter(position == "WR" | position == "RB" | position == "TE")
DF.Off.strength <- DF.clean %>% 
  filter(position == "C" | position == "OG" | position == "OT" | position == "OL")
DF.Def.skill <- DF.clean %>% 
  filter(position == "DB" | position == "S")
DF.Def.strength <- DF.clean %>% 
  filter(position == "DE" | position == "DL" | position == "DT" | position == "LB" | position == "OLB")
```

Quick read in cleaned data 
--------------------------
```{r}
DF.Off.skill <- read.csv("derived_data/Off.Skill.csv")
DF.Off.strength <- read.csv("derived_data/Off.Strength.csv")
DF.Def.skill <- read.csv("derived_data/Def.Skill.csv")
DF.Def.strength <- read.csv("derived_data/Def.Strength.csv")
```

Graphs
```{r}
g1 <- ggplot(DF.Off.skill, mapping = aes(x = combine40yd, y = pick, color = position)) +     geom_point(alpha = .5) +
  xlab("40 Time") +
  ylab("Pick") +
  labs(color = "Position", title = "Offense") +
  xlim(4, 5.2) +
  theme(legend.position = c(0, 1),
                  legend.justification = c(0, 1))

g2 <- ggplot(DF.Off.strength, mapping = aes(x = combineBench, y = pick, color = position)) +     geom_point(alpha = .5) +
  xlab("Benchpress") +
  ylab("Pick") +
  labs(color = "Position")

g3 <- ggplot(DF.Def.skill, mapping = aes(x = combine40yd, y = pick, color = position)) +     geom_point(alpha = .5) +
  xlab("40 Time") +
  ylab("Pick") +
  labs(color = "Position", title = "Defense") +
  xlim(4, 5.2) +
  theme(legend.position = c(0, 1),
                  legend.justification = c(0, 1))

g4 <- ggplot(DF.Def.strength, mapping = aes(x = combineBench, y = pick, color = position)) +     geom_point(alpha = .5) +
  xlab("Benchpress") +
  ylab("Pick") +
  labs(color = "Position")

# g1
# g2
# g3
# g4
```

```{r}
Graph1 <- grid.arrange(g1, g3, nrow=1)
ggsave("derived_graphs/Off.Def.40s.png", plot = Graph1)
```

weights
```{r}
g5 <- ggplot(DF.Off.skill, aes(weight)) +
  geom_density(aes(color=position), alpha=.5) +
  xlim(170, 400) +
  xlab("Weights") +
  ylab("") +
  labs(color="Position") +
   theme(legend.position = c(0, 1),
                  legend.justification = c(0, 1))

g6 <- ggplot(DF.Off.strength, aes(weight)) +
  geom_density(aes(color=position), alpha=.5) +
  xlim(170,400) +
  xlab("Weights") +
  ylab("") +
  labs(color="Position") +
   theme(legend.position = c(0, 1),
                  legend.justification = c(0, 1))
# g5
# g6

Graph2 <- grid.arrange(g5, g6, nrow=1, top = "Weight Distribution by Position (Offense)")
```

```{r}
g7 <- ggplot(DF.Off.skill, aes(ageAtDraft)) +
  geom_histogram(aes(fill = position), position = "dodge") +
  xlab("Age at Draft") +
  ylab("Count") +
  labs(fill = "Position", title = "Offense Skill") +
  theme(legend.position = c(0, 1),
        legend.justification = c(0, 1),
        legend.key.size = unit(.25, "cm")) +
  theme(axis.text.y=element_blank())

g8 <- ggplot(DF.Off.strength, aes(ageAtDraft)) +
  geom_histogram(aes(fill = position), position = "dodge") +
  xlab("Age at Draft") +
  ylab("Count") +
  labs(fill = "Position", title = "Offense Line") +
  theme(legend.position = c(0, 1),
        legend.justification = c(0, 1),
        legend.key.size = unit(.25, "cm")) +
  theme(axis.text.y=element_blank())

g9 <- ggplot(DF.Def.skill, aes(ageAtDraft)) +
  geom_histogram(aes(fill = position), position = "dodge") +
  xlab("Age at Draft") +
  ylab("Count") +
  labs(fill = "Position", title = "Defense Skill") +
  theme(legend.position = c(0, 1),
        legend.justification = c(0, 1),
        legend.key.size = unit(.25, "cm")) +
  theme(axis.text.y=element_blank())

g10 <- ggplot(DF.Def.strength, aes(ageAtDraft)) +
  geom_histogram(aes(fill = position), position = "dodge") +
  xlab("Age at Draft") +
  ylab("Count") +
  labs(fill = "Position", title = "Defense Line") +
  theme(legend.position = c(0, 1),
        legend.justification = c(0, 1),
        legend.key.size = unit(.25, "cm")) +
  theme(axis.text.y=element_blank())

# g7
# g8
# g9
# g10

Graphs3 <- grid.arrange(g7, g8, g9, g10, nrow=2, top = "Age Distribution by Position")
```

```{r}
g11 <- DF.clean %>% 
  filter(position != "QB" & position != "LS") %>% 
  ggplot(aes(x=position, y=round, color = position)) +     
  geom_boxplot() +
  xlab("Position") +
  ylab("Pick") + 
  theme(legend.position = "none")

g11

```

Read in full set
```{r}
Clean_Data <- read.csv("derived_data/Clean_Data.csv") %>% 
  mutate(position = as.numeric(position))
```

Add a tag of skill or strength for clustering Combine the 4 data sets with the tag
```{r}
DF.Off.skill <- read.csv("derived_data/Off.Skill.csv") %>% 
  mutate(Type = "1") #skill is 1, strength is 2, linebacker is 3
DF.Off.strength <- read.csv("derived_data/Off.Strength.csv") %>% 
  mutate(Type = "2")
DF.Def.skill <- read.csv("derived_data/Def.Skill.csv" )%>% 
  mutate(Type = "1")
DF.Def.strength <- read.csv("derived_data/Def.Strength.csv" )%>% 
  mutate(Type = "2")
DF.Def.LBs <- read.csv("derived_data/Def.LBs.csv") %>% 
  mutate(Type = "3")
Skill.Stren.DF <- rbind(DF.Off.skill, DF.Off.strength, DF.Def.strength, DF.Def.skill, DF.Def.LBs)
```

Clustering
------

Initial split of data into test/train/validate
```{r}
set.seed <- 18 #this is my lucky number 
spec = c(train = .6, test = .2, validate = .2)
DF = sample(cut(
  seq(nrow(Clean_Data)), 
  nrow(Clean_Data)*cumsum(c(0,spec)),
  labels = names(spec)
))

Split.DF = split(Clean_Data, DF)
```

TSNE
```{r}
set.seed = 18
library(Rtsne)
fit1 <- Rtsne(Skill.Stren.DF %>% select(heightInches, weight, 7:12), dims=2, check_duplicates = F)
ggplot(fit1$Y %>% as.data.frame() %>% as_tibble(), aes(V1,V2)) +
    geom_point(aes(color=Skill.Stren.DF$Type)) +
    scale_color_discrete(name="Type", labels = c("Skill", "Strength", "Mixed"))
```
Did not exactly trust TSNE becasue it is non-linear so lets try k-means. 



K-nearest neighbor
```{r}
library(class)
results1 <- do.call(rbind, Map(function(n) {
  predictions <- knn(train = Split.DF$train,
                     test = Split.DF$test, 
                     cl = Split.DF$train$position, 
                     k=n)
  acc <- sum(predictions == Split.DF$validate$position)/length(predictions)
  tibble(k=n, acc=acc)
}, seq(1, 100))) %>% 
  arrange(desc(acc), k)

results1 %>% arrange(desc(acc),k) %>% head(5)
```

K-means

```{r}
set.seed = 18
cc <- kmeans(Skill.Stren.DF %>% select(heightInches, weight, 7:12), 3)
fit1 <- Rtsne(Skill.Stren.DF %>% select(heightInches, weight, 7:12), dims=2, check_duplicates = F)
ggplot(fit1$Y %>% as.data.frame() %>% as_tibble() %>% mutate(label=cc$cluster),aes(V1,V2)) +
    geom_point(aes(color=factor(label))) +
    scale_color_discrete(name="Type", labels = c("Skill", "Strength", "Mixed"))
```

The groups of athletes, although there is sort of a spectrum. Clustering is happening in unreduced number of dimensions and clusters still show up when we reduce the dimensionality. looks like there really are three groups, lets try to see use Principle Component Analysis

GLM
```{r}
glm1 <- glm(pick ~ position + 
              heightInches + 
              weight + 
              ageAtDraft + 
              combine40yd + 
              combineVert + 
              combineBench +
              combineShuttle +
              combineBroad +
              combine3cone, family = poisson, data = Split.DF$train)
anova(glm1, test = "Chisq")
step(glm1, direction = "both", trace = 0)

glm2 <- glm(pick ~ position + 
              heightInches + 
              ageAtDraft + 
              combine40yd + 
              combineVert + 
              combineBench +
              combineShuttle +
              combineBroad +
              combine3cone, family = poisson, data = Split.DF$train)
summary(glm2)
anova(glm2, test = "Chisq")
```

Lasso and Ridge
```{r}
set.seed = 18
library(glmnet)



```


